<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì—°ì•  ìƒë‹´ ë¦¬í¬íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #020617;
      --bg-card: rgba(15, 23, 42, 0.96);
      --bg-soft: rgba(30, 64, 175, 0.18);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --accent: #38bdf8;
      --accent-2: #6366f1;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 55%, #020617 100%);
      color: var(--text-main);
      margin: 0;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .container {
      max-width: 720px;
      width: 100%;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 18px 18px 22px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.25);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right,
        rgba(56, 189, 248, 0.12),
        transparent 60%);
      opacity: 0.8;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    /* í—¤ë” */
    .header-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .header-badge span {
      font-size: 13px;
      margin-right: 4px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .divider {
      height: 1px;
      width: 100%;
      margin: 12px 0 6px;
      background: linear-gradient(
        90deg,
        rgba(148, 163, 184, 0.0),
        rgba(148, 163, 184, 0.45),
        rgba(148, 163, 184, 0.0)
      );
    }

    /* ê³µí†µ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    section.section {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px dashed rgba(55, 65, 81, 0.8);
    }

    section.section:first-of-type {
      border-top: none;
      padding-top: 4px;
      margin-top: 6px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .section-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: rgba(30, 64, 175, 0.45);
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
    }

    .section-caption {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .section-body {
      font-size: 13px;
      line-height: 1.6;
    }

    /* ì¹´ë“œí˜• ì„¹ì…˜ */
    .section-card {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 12px;
      border: 1px solid rgba(30, 64, 175, 0.4);
      padding: 10px 12px 12px;
      margin-top: 10px;
    }

    /* ì ìˆ˜ */
    .scores-grid {
      margin-top: 4px;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 6px;
      gap: 8px;
    }

    .score-label {
      min-width: 70px;
      color: var(--text-sub);
    }

    .score-bar {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: rgba(30, 41, 59, 0.95);
      overflow: hidden;
    }

    .score-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      width: 0;
      transition: width 0.45s ease-out;
    }

    /* ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ */
    .section-list {
      margin-top: 2px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .section-list ul {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
      line-height: 1.7;
    }

    .section-list li + li {
      margin-top: 2px;
    }

    /* ì‘ì€ í…ìŠ¤íŠ¸ */
    .small {
      font-size: 11.5px;
      color: var(--text-sub);
      margin-top: 16px;
      line-height: 1.5;
    }

    .loading {
      text-align: center;
      padding: 40px 0;
      font-size: 14px;
      color: var(--text-sub);
    }

    .error {
      text-align: center;
      padding: 40px 0;
      font-size: 14px;
      color: #fca5a5;
    }

    .muted {
      color: var(--text-sub);
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-inner">
        <div id="loading" class="loading">ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>
        <div id="content" style="display:none;"></div>
        <div id="error" class="error" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB5QlAypsF-xEspPjkD14DEfqKsIRQAc2Y",
      authDomain: "trybob-db6d0.firebaseapp.com",
      projectId: "trybob-db6d0",
      storageBucket: "trybob-db6d0.firebasestorage.app",
      messagingSenderId: "1064274282875",
      appId: "1:1064274282875:web:8b3790473ae3e1836bd5de",
      measurementId: "G-4LC9Z96K1D"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db  = getFirestore(app);

    function getReportIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    function showError(msg) {
      document.getElementById("loading").style.display = "none";
      const err = document.getElementById("error");
      err.style.display = "block";
      err.textContent = msg;
    }

    function renderReport(data) {
      const loading = document.getElementById("loading");
      const content = document.getElementById("content");
      loading.style.display = "none";
      content.style.display = "block";

      const {
        title,
        love_animal,
        scores,
        scores_comment,
        good_matches,
        potential_mismatches,
        strengths,
        improvements,
        date_tips,
        mbti_note,
        extra_fun,
        disclaimer
      } = data;

      content.innerHTML = "";

      // â”€â”€ í—¤ë” ì˜ì—­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const header = document.createElement("div");
      header.innerHTML = `
        <div class="header-badge">
          <span>ğŸ’˜</span> AI LOVE COUNSEL REPORT
        </div>
        <div class="title">${title ?? "AI ì—°ì•  ìƒë‹´ ë¦¬í¬íŠ¸"}</div>
        <div class="subtitle">
          AIê°€ í”„ë¡œí•„ì„ ë¶„ì„í•´ ì •ë¦¬í•œ ë‚˜ì˜ ì—°ì•  ì„±í–¥ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.
        </div>
        <div class="divider"></div>
      `;
      content.appendChild(header);

      // â”€â”€ ì—°ì•  ë™ë¬¼ ì„¹ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (love_animal) {
        const section = document.createElement("section");
        section.className = "section";

        const inner = document.createElement("div");
        inner.className = "section-card";
        inner.innerHTML = `
          <div class="section-header">
            <div class="section-icon">ğŸ¾</div>
            <div>
              <div class="section-title">ë‚˜ë¥¼ ë‹®ì€ ì—°ì•  ë™ë¬¼</div>
              <div class="section-caption">ë‚´ ì—°ì•  ìŠ¤íƒ€ì¼ì„ ë™ë¬¼ ìºë¦­í„°ë¡œ í‘œí˜„í•œ í•œ ì¤„ ìš”ì•½</div>
            </div>
          </div>
          <div class="section-body">
            <div style="font-size:14px; font-weight:600; margin-bottom:4px;">
              ${love_animal.name ?? ""}
            </div>
            <div style="font-size:13px; line-height:1.6;">
              ${love_animal.description ?? ""}
            </div>
          </div>
        `;
        section.appendChild(inner);
        content.appendChild(section);
      }

      // â”€â”€ ì—°ì•  ì„±í–¥ ì ìˆ˜ ì„¹ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (scores) {
        const section = document.createElement("section");
        section.className = "section";

        const inner = document.createElement("div");
        inner.className = "section-card";
        inner.innerHTML = `
          <div class="section-header">
            <div class="section-icon">ğŸ“Š</div>
            <div>
              <div class="section-title">ì—°ì•  ì„±í–¥ ì ìˆ˜</div>
              <div class="section-caption">ë‚´ ì—°ì•  ìŠ¤íƒ€ì¼ì„ 5ê°€ì§€ ì¶•ìœ¼ë¡œ ì •ë¦¬í•œ ì ìˆ˜ ì¹´ë“œ</div>
            </div>
          </div>
        `;

        const scoresGrid = document.createElement("div");
        scoresGrid.className = "scores-grid";

        const labelMap = {
          stability: "ì•ˆì •ì„±",
          expression: "ê°ì • í‘œí˜„",
          independence: "ë…ë¦½ì„±",
          communication: "ì†Œí†µ",
          conflict_handling: "ê°ˆë“± ëŒ€ì²˜"
        };

        Object.entries(scores).forEach(([key, value]) => {
          const row = document.createElement("div");
          row.className = "score-row";
          const label = labelMap[key] ?? key;
          const max = (value <= 5 ? 5 : 100);
          const percent = Math.min(100, (value / max) * 100);

          row.innerHTML = `
            <div class="score-label">${label}</div>
            <div class="score-bar">
              <div class="score-bar-fill" style="width:${percent}%;"></div>
            </div>
          `;
          scoresGrid.appendChild(row);
        });

        inner.appendChild(scoresGrid);

        if (scores_comment) {
          const p = document.createElement("p");
          p.style.fontSize = "13px";
          p.style.marginTop = "8px";
          p.style.lineHeight = "1.6";
          p.textContent = scores_comment;
          inner.appendChild(p);
        }

        section.appendChild(inner);
        content.appendChild(section);
      }

      // ê³µí†µ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ í—¬í¼
      function addListSection(icon, titleText, captionText, items) {
        if (!items || !items.length) return;
        const section = document.createElement("section");
        section.className = "section";

        const header = document.createElement("div");
        header.className = "section-header";
        header.innerHTML = `
          <div class="section-icon">${icon}</div>
          <div>
            <div class="section-title">${titleText}</div>
            ${captionText ? `<div class="section-caption">${captionText}</div>` : ""}
          </div>
        `;

        const box = document.createElement("div");
        box.className = "section-list";
        const list = document.createElement("ul");
        items.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          list.appendChild(li);
        });
        box.appendChild(list);

        section.appendChild(header);
        section.appendChild(box);
        content.appendChild(section);
      }

      addListSection("ğŸ’", "ì˜ ë§ëŠ” íƒ€ì…", "í•¨ê»˜ ìˆì„ ë•Œ í¸ì•ˆí•˜ê³ , ê´€ê³„ê°€ ìì—°ìŠ¤ëŸ½ê²Œ í˜ëŸ¬ê°€ëŠ” ì‚¬ëŒë“¤", good_matches);
      addListSection("âš ï¸", "ì£¼ì˜ê°€ í•„ìš”í•œ íƒ€ì…", "ì„œë¡œì˜ ì°¨ì´ë¥¼ ì´í•´í•˜ëŠ” ë° ì‹œê°„ì´ ë” í•„ìš”í•  ìˆ˜ ìˆëŠ” ì¡°í•©", potential_mismatches);
      addListSection("âœ¨", "ë‚˜ì˜ ë§¤ë ¥ í¬ì¸íŠ¸", "ìƒëŒ€ê°€ ì¢‹ì•„í•  ë§Œí•œ ë‚˜ì˜ ê°•ì ë“¤", strengths);
      addListSection("ğŸŒ±", "ì¡°ê¸ˆë§Œ ë” ë³´ì™„í•˜ë©´ ì¢‹ì€ ì ", "ì¡°ê¸ˆì”© ì—°ìŠµí•˜ë©´ ê´€ê³„ê°€ ë” í¸ì•ˆí•´ì§ˆ ë¶€ë¶„ë“¤", improvements);

      // ë°ì´íŠ¸ íŒ
      if (date_tips) {
        if (date_tips.things_to_try && date_tips.things_to_try.length) {
          addListSection("ğŸ“…", "ì¶”ì²œ ë°ì´íŠ¸ ì•„ì´ë””ì–´", "ë‚˜ì˜ ì„±í–¥ì— ì˜ ë§ëŠ” ë°ì´íŠ¸/ë§Œë‚¨ ë°©ì‹ ì œì•ˆ", date_tips.things_to_try);
        }
        if (date_tips.conversation_tips && date_tips.conversation_tips.length) {
          addListSection("ğŸ’¬", "ëŒ€í™” íŒ", "ì–´ìƒ‰í•¨ì„ ì¤„ì´ê³  ìì—°ìŠ¤ëŸ½ê²Œ ê¹Šì–´ì§€ëŠ” ëŒ€í™” í¬ì¸íŠ¸", date_tips.conversation_tips);
        }
        if (date_tips.first_message_example && date_tips.first_message_example.length) {
          addListSection("ğŸ“©", "ì²« ë©”ì‹œì§€ ì˜ˆì‹œ", "ì‹¤ì œë¡œ ë°”ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ì²« ë©”ì‹œì§€ ë¬¸ì¥", date_tips.first_message_example);
        }
      }

      // MBTI í•´ì„¤
      if (mbti_note) {
        const section = document.createElement("section");
        section.className = "section";
        section.innerHTML = `
          <div class="section-header">
            <div class="section-icon">ğŸ§ </div>
            <div>
              <div class="section-title">MBTI í•´ì„¤</div>
              <div class="section-caption">ë‚´ MBTI ì„±í–¥ì„ ì—°ì•  ê´€ì ì—ì„œ í’€ì–´ì“´ í•´ì„¤</div>
            </div>
          </div>
          <div class="section-body">
            <p style="font-size:13px; line-height:1.6;">${mbti_note}</p>
          </div>
        `;
        content.appendChild(section);
      }

      // ì¬ë¯¸ ìš”ì†Œ
      if (extra_fun) {
        const section = document.createElement("section");
        section.className = "section";
        section.innerHTML = `
          <div class="section-header">
            <div class="section-icon">ğŸ€</div>
            <div>
              <div class="section-title">ì¬ë¯¸ë¡œ ë³´ëŠ” í•œ ì¤„ ì½”ë©˜íŠ¸</div>
              <div class="section-caption">ì¡°ê¸ˆì€ ê°€ë³ê²Œ, ë‚´ ì—°ì•  ìºë¦­í„°ë¥¼ í•œ ì¤„ë¡œ ì •ë¦¬</div>
            </div>
          </div>
          <div class="section-body">
            <p style="font-size:13px; line-height:1.6;">${extra_fun}</p>
          </div>
        `;
        content.appendChild(section);
      }

      // ë©´ì±… ë¬¸êµ¬
      if (disclaimer) {
        const small = document.createElement("p");
        small.className = "small";
        small.textContent = disclaimer;
        content.appendChild(small);
      }

      const foot = document.createElement("div");
      foot.className = "muted";
      foot.textContent = "â€» ì´ ë¦¬í¬íŠ¸ëŠ” ì°¸ê³ ìš© ê°€ì´ë“œì´ë©°, ì‹¤ì œ ì—°ì•  ê²½í—˜ê³¼ ì„ íƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤.";
      content.appendChild(foot);
    }

    async function main() {
      const id = getReportIdFromUrl();
      if (!id) {
        showError("ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬ì…ë‹ˆë‹¤. (idê°€ ì—†ìŠµë‹ˆë‹¤)");
        return;
      }

      try {
        const ref  = doc(db, "loveCounselReports", id);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          showError("í•´ë‹¹ ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const data = snap.data();
        if (!data || !data.counselData) {
          showError("ë¦¬í¬íŠ¸ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }
        renderReport(data.counselData);
      } catch (e) {
        console.error(e);
        showError("ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    main();
  </script>
</body>
</html>

