<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì—°ì•  ìƒë‹´ ë¦¬í¬íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 720px;
      width: 100%;
    }
    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 20px 20px 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 16px 0 6px;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(59, 130, 246, 0.15);
      color: #bfdbfe;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      margin-bottom: 6px;
    }
    .score-bar {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      margin-left: 8px;
      background: rgba(55, 65, 81, 0.9);
      overflow: hidden;
    }
    .score-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #38bdf8, #6366f1);
      width: 0;
      transition: width .4s ease-out;
    }
    .chips {
      margin-top: 4px;
    }
    .small {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 16px;
      line-height: 1.5;
    }
    .loading {
      text-align: center;
      padding: 40px 0;
      font-size: 14px;
      color: #9ca3af;
    }
    .error {
      text-align: center;
      padding: 40px 0;
      font-size: 14px;
      color: #fca5a5;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="card" class="card">
      <div id="loading" class="loading">ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>
      <div id="content" style="display:none;"></div>
      <div id="error" class="error" style="display:none;"></div>
    </div>
  </div>

  <!-- Firebase JS SDK (v11 ì˜ˆì‹œ, ë²„ì „ì€ ìµœì‹ ìœ¼ë¡œ ë°”ê¿”ë„ ë¨) -->
  <script type="module">
    // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyB5QlAypsF-xEspPjkD14DEfqKsIRQAc2Y",
    authDomain: "trybob-db6d0.firebaseapp.com",
    projectId: "trybob-db6d0",
    storageBucket: "trybob-db6d0.firebasestorage.app",
    messagingSenderId: "1064274282875",
    appId: "1:1064274282875:web:8b3790473ae3e1836bd5de",
    measurementId: "G-4LC9Z96K1D"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
    const db  = getFirestore(app);

    function getReportIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    function showError(msg) {
      document.getElementById("loading").style.display = "none";
      const err = document.getElementById("error");
      err.style.display = "block";
      err.textContent = msg;
    }

    function renderReport(data) {
      const loading = document.getElementById("loading");
      const content = document.getElementById("content");
      loading.style.display = "none";
      content.style.display = "block";

      const {
        title,
        love_animal,
        scores,
        scores_comment,
        good_matches,
        potential_mismatches,
        strengths,
        improvements,
        date_tips,
        mbti_note,
        extra_fun,
        disclaimer
      } = data;

      content.innerHTML = "";

      const header = document.createElement("div");
      header.innerHTML = `
        <div class="title">${title ?? "AI ì—°ì•  ìƒë‹´ ë¦¬í¬íŠ¸"}</div>
        <div class="subtitle">AIê°€ í”„ë¡œí•„ì„ ë¶„ì„í•´ ìš”ì•½í•œ ë‚˜ì˜ ì—°ì•  ì„±í–¥ ì¹´ë“œì…ë‹ˆë‹¤.</div>
      `;
      content.appendChild(header);

      if (love_animal) {
        const section = document.createElement("section");
        section.innerHTML = `
          <div class="section-title">ë‚˜ë¥¼ ë‹®ì€ ì—°ì•  ë™ë¬¼ ğŸ¾</div>
          <div style="font-size:14px; font-weight:600; margin-bottom:4px;">
            ${love_animal.name ?? ""}
          </div>
          <div style="font-size:13px; line-height:1.6;">
            ${love_animal.description ?? ""}
          </div>
        `;
        content.appendChild(section);
      }

      if (scores) {
        const section = document.createElement("section");
        section.innerHTML = `
          <div class="section-title">ì—°ì•  ì„±í–¥ ì ìˆ˜</div>
        `;
        Object.entries(scores).forEach(([key, value]) => {
          const row = document.createElement("div");
          row.className = "score-row";
          const labelMap = {
            stability: "ì•ˆì •ì„±",
            expression: "ê°ì • í‘œí˜„",
            independence: "ë…ë¦½ì„±",
            communication: "ì†Œí†µ",
            conflict_handling: "ê°ˆë“± ëŒ€ì²˜"
          };
          const label = labelMap[key] ?? key;
          const max = (value <= 5 ? 5 : 100); // 1~5 ìŠ¤ì¼€ì¼ì¸ì§€ 100ì  ìŠ¤ì¼€ì¼ì¸ì§€ì— ë”°ë¼ ì¡°ì •
          const percent = Math.min(100, (value / max) * 100);
          row.innerHTML = `
            <span>${label}</span>
            <div class="score-bar">
              <div class="score-bar-fill" style="width:${percent}%;"></div>
            </div>
          `;
          section.appendChild(row);
        });
        if (scores_comment) {
          const p = document.createElement("p");
          p.style.fontSize = "13px";
          p.style.marginTop = "8px";
          p.style.lineHeight = "1.6";
          p.textContent = scores_comment;
          section.appendChild(p);
        }
        content.appendChild(section);
      }

      function addListSection(title, items) {
        if (!items || !items.length) return;
        const section = document.createElement("section");
        section.innerHTML = `<div class="section-title">${title}</div>`;
        const list = document.createElement("ul");
        list.style.paddingLeft = "18px";
        list.style.fontSize = "13px";
        list.style.lineHeight = "1.6";
        items.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          list.appendChild(li);
        });
        section.appendChild(list);
        content.appendChild(section);
      }

      addListSection("ì˜ ë§ëŠ” íƒ€ì…", good_matches);
      addListSection("ì£¼ì˜ê°€ í•„ìš”í•œ íƒ€ì…", potential_mismatches);
      addListSection("ë‚˜ì˜ ë§¤ë ¥ í¬ì¸íŠ¸", strengths);
      addListSection("ì¡°ê¸ˆë§Œ ë” ë³´ì™„í•˜ë©´ ì¢‹ì€ ì ", improvements);

      if (date_tips) {
        if (date_tips.things_to_try && date_tips.things_to_try.length) {
          addListSection("ì¶”ì²œ ë°ì´íŠ¸ ì•„ì´ë””ì–´", date_tips.things_to_try);
        }
        if (date_tips.conversation_tips && date_tips.conversation_tips.length) {
          addListSection("ëŒ€í™” íŒ", date_tips.conversation_tips);
        }
        if (date_tips.first_message_example && date_tips.first_message_example.length) {
          addListSection("ì²« ë©”ì‹œì§€ ì˜ˆì‹œ", date_tips.first_message_example);
        }
      }

      if (mbti_note) {
        const section = document.createElement("section");
        section.innerHTML = `
          <div class="section-title">MBTI í•´ì„¤</div>
          <p style="font-size:13px; line-height:1.6;">${mbti_note}</p>
        `;
        content.appendChild(section);
      }

      if (extra_fun) {
        const section = document.createElement("section");
        section.innerHTML = `
          <div class="section-title">ì¬ë¯¸ë¡œ ë³´ëŠ” í•œ ì¤„ ì½”ë©˜íŠ¸</div>
          <p style="font-size:13px; line-height:1.6;">${extra_fun}</p>
        `;
        content.appendChild(section);
      }

      if (disclaimer) {
        const small = document.createElement("p");
        small.className = "small";
        small.textContent = disclaimer;
        content.appendChild(small);
      }
    }

    async function main() {
      const id = getReportIdFromUrl();
      if (!id) {
        showError("ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬ì…ë‹ˆë‹¤. (idê°€ ì—†ìŠµë‹ˆë‹¤)");
        return;
      }

      try {
        const ref  = doc(db, "loveCounselReports", id);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          showError("í•´ë‹¹ ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const data = snap.data();
        if (!data || !data.counselData) {
          showError("ë¦¬í¬íŠ¸ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }
        renderReport(data.counselData);
      } catch (e) {
        console.error(e);
        showError("ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    main();
  </script>
</body>
</html>
